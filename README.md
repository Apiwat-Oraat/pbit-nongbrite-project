# P'Bit Nong'Brite Learning Platform

> üöß **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞**: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤ (WIP) ‚Äî ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÅ‡∏Å‡πà‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡πà‡∏°

## üéØ Concept

‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏° (game-based learning) ‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô Chapter ‚Üí Level ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡πÉ‡∏à (Lives), ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô, ‡∏™‡∏∞‡∏™‡∏°‡∏î‡∏≤‡∏ß/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô, ‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢ Streak ‡πÅ‡∏•‡∏∞ Achievements ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Ranking cache ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå

- **‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Learner)** ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏á‡∏Ç‡∏±‡πâ‡∏ô, ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå, ‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
- **‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Chapter & Level)** ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏°‡∏µ max score/stars ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏î‡∏ú‡∏•
- **‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏•‡∏¢‡πå (GamePlayHistory + LevelCompletion)** ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á best score/best time
- **Gamification Layer**: lives, streaks, achievements, icons, ranking ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° retention

## üõ£Ô∏è API Structure (`/api/v1`)

### Health Check
| Method | Endpoint | Description | Auth |
| ------ | -------- | ----------- | ---- |
| GET | `/health` | ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ server | ‚ùå |

### Authentication
| Method | Endpoint | Description | Auth |
| ------ | -------- | ----------- | ---- |
| POST | `/auth/login` | ‡∏≠‡∏µ‡πÄ‡∏°‡∏•+‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö access/refresh token (cookie) | ‚ùå |
| POST | `/auth/logout` | ‡∏•‡πâ‡∏≤‡∏á cookie + refresh token | ‚úÖ (cookie) |
| POST | `/auth/refresh` | ‡∏≠‡∏≠‡∏Å access token ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å refresh token | ‚úÖ (cookie) |
| POST | `/auth/register/step1` | ‡∏™‡πà‡∏á email/password ‡∏£‡∏±‡∏ö register token | ‚ùå |
| POST | `/auth/register/step2` | ‡∏™‡πà‡∏á profile data ‡∏û‡∏£‡πâ‡∏≠‡∏° register token ‡πÉ‡∏ô cookie | ‚úÖ (register cookie) |
| POST | `/auth/forgot-password` | ‡∏™‡πà‡∏á PIN ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™ (idempotent) | ‚ùå |
| POST | `/auth/reset-password` | ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢ email + PIN + new password | ‚ùå |

### User Profile
| Method | Endpoint | Description | Auth |
| ------ | -------- | ----------- | ---- |
| GET | `/user/profile` | ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• profile ‡∏Ç‡∏≠‡∏á user | ‚úÖ |
| PUT | `/user/profile` | ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï profile (name, age, gender, icon) | ‚úÖ |

### Lives Management
| Method | Endpoint | Description | Auth |
| ------ | -------- | ----------- | ---- |
| GET | `/users/lives` | ‡∏î‡∏π‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (auto reset ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô) | ‚úÖ |
| PUT | `/users/lives` | ‡πÉ‡∏ä‡πâ‡∏´‡∏±‡∏ß‡πÉ‡∏à 1 ‡∏î‡∏ß‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° | ‚úÖ |
| PUT | `/users/lives/reset` | ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏° | ‚úÖ |

### Streak
| Method | Endpoint | Description | Auth |
| ------ | -------- | ----------- | ---- |
| GET | `/users/streak` | ‡∏î‡∏π streak ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î | ‚úÖ |
| PUT | `/users/streak/update` | ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï streak ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà | ‚úÖ |

### Chapters
| Method | Endpoint | Description | Auth |
| ------ | -------- | ----------- | ---- |
| GET | `/chapters` | ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ chapter + level ‡∏ó‡∏µ‡πà active | ‚úÖ |
| GET | `/chapters/progress` | ‡∏î‡∏∂‡∏á chapters ‡∏û‡∏£‡πâ‡∏≠‡∏° progress (stars, levelsPassed) | ‚úÖ |
| GET | `/chapters/:chapterId` | ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î chapter ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß | ‚úÖ |

### Game
| Method | Endpoint | Description | Auth |
| ------ | -------- | ----------- | ---- |
| GET | `/game/ranking` | ‡∏î‡∏∂‡∏á leaderboard/ranking ‡∏à‡∏≤‡∏Å cache | ‚úÖ |
| GET | `/game/last-stage` | ‡∏î‡∏∂‡∏á‡∏î‡πà‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà user ‡πÄ‡∏•‡πà‡∏ô (chapter, level, score, stars) | ‚úÖ |
| POST | `/game/submit` | ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏•‡πà‡∏ô level (score/stars/time) | ‚úÖ |
| POST | `/game/rebuild-cache` | Rebuild ranking cache ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (admin) | ‚úÖ |

> ‡∏ó‡∏∏‡∏Å endpoint ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏ä‡πâ `authMiddleware.verifyToken` ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö access token ‡∏à‡∏≤‡∏Å HTTP-only cookie

## ‚ú® Features

- **Secure onboarding**: ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ 2 ‡∏Ç‡∏±‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° register token, JWT access+refresh ‡∏î‡πâ‡∏ß‡∏¢ rotation, logout ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
- **User profile management**: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç name, age, gender, icon ‡∏ú‡πà‡∏≤‡∏ô API
- **Gamified progression**: Chapter/Level, best score/stars/time, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô, last stage tracking
- **Progress tracking**: ‡∏î‡∏∂‡∏á chapters ‡∏û‡∏£‡πâ‡∏≠‡∏° progress (stars earned, levels passed, completion %)
- **Lives management**: quota ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô, ‡∏ï‡∏£‡∏ß‡∏à reset ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥, error `NO_LIVES_LEFT`
- **Daily streak engine**: ‡∏ï‡∏£‡∏ß‡∏à same-day/next-day ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥, ‡πÄ‡∏Å‡πá‡∏ö longest streak, sync ‡∏Å‡∏±‡∏ö Profile
- **Ranking system**: Leaderboard ‡∏û‡∏£‡πâ‡∏≠‡∏° RankingCache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö performance ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
- **Email recovery**: ‡∏™‡πà‡∏á PIN 6 ‡∏´‡∏•‡∏±‡∏Å‡∏ú‡πà‡∏≤‡∏ô Nodemailer, token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ
- **Prisma + PostgreSQL schema**: strongly typed models, enum, composite index/unique constraints, cascade delete
- **Docker-first**: Postgres, backend, (frontend stub) ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ `docker-compose`

## üß∞ Tech Stack

- **Backend**: Node.js + Express 5 + Prisma ORM + JWT + Nodemailer
- **Database**: PostgreSQL 16
- **Infrastructure**: Docker, Docker Compose, Prisma migrations
- **Auth & Security**: bcrypt hashing, HTTP-only cookies, token rotation, role enum

## üöÄ How to Run

### 1. System Requirements

- Docker Desktop (‡∏£‡∏ß‡∏° Docker Compose)
- Git
- ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏ô‡∏≠‡∏Å Docker: Node.js 20+, npm, PostgreSQL 16

### 2. Clone & Configure

```bash
git clone <repository-url>
cd PROJECT-P'BIT-NONG'BRITE - TEST-2
cp back-end/.env.example back-end/.env  # (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
```

### 3. Run with Docker

```bash
# build ‡πÅ‡∏•‡∏∞ start (‡∏î‡∏π log ‡πÉ‡∏ô terminal)
docker-compose up --build

# ‡∏´‡∏£‡∏∑‡∏≠ background mode
docker-compose up -d --build
```

### 4. Access
- Backend API: `http://localhost:4000/api/v1`
- PostgreSQL: `localhost:5432`

### 5. Useful commands

```bash
# Logs
docker-compose logs -f
docker-compose logs -f backend

# Stop / clean
docker-compose down
docker-compose down -v          # ‡∏•‡πâ‡∏≤‡∏á volume

# Restart service ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
docker-compose restart backend
```

### 6. Database migration

```bash
docker-compose exec backend npx prisma migrate dev
docker-compose exec backend npx prisma generate
```

## üõ†Ô∏è Development Tips

- ‡πÇ‡∏Ñ‡πâ‡∏î backend mount ‡πÄ‡∏Ç‡πâ‡∏≤ container ‡∏™‡∏î ‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á restart ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏ü‡∏•‡πå
- ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å container:

```bash
docker-compose exec backend bash
npm install <package>
exit
docker-compose up --build backend
```

## üß± Project Structure

```
project/
‚îú‚îÄ‚îÄ back-end/                  # Express + Prisma
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ backend-dockerfile
‚îú‚îÄ‚îÄ front-end/                 # React/Next (Dockerfile ‡∏û‡∏£‡πâ‡∏≠‡∏°)
‚îÇ   ‚îî‚îÄ‚îÄ fontend-dockerfile
‚îî‚îÄ‚îÄ docker-compose.yml         # Orchestrates db/backend/(frontend)
```

## ü©∫ Troubleshooting

- **Port ‡∏ä‡∏ô**: stop service ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ port ‡πÉ‡∏ô `docker-compose.yml`
- **DB connection refused**: ‡∏£‡∏≠ Postgres ‡∏Ç‡∏∂‡πâ‡∏ô (healthcheck ~60s) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ env `DATABASE_URL`
- **Low disk**: `docker system prune -a`
- **Check status**:

```bash
docker-compose ps
docker-compose exec db pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}
```
