generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())

  username     String   @unique
  email        String   @unique
  password     String
  name         String?
  age          Int?
  gender       Gender?

  resetPin     String?
  resetExpire  DateTime?

  role         Role     @default(USER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // relations
  lastStage        LastStage?
  levelCompletions LevelCompletion[]
  gamePlayHistory  GamePlayHistory[]
  lives            Life?
  profile          Profile?
  rankingCache     RankingCache?
  streaks          Streak[]
  userStats        UserStats?
  
}

model Streak {
  id             Int       @id @default(autoincrement())
  userId         Int       @unique
  current        Int       @default(0)
  longest        Int       @default(0)
  lastActiveDate DateTime?
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Life {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  current     Int      @default(5)
  max         Int      @default(5)
  updatedAt   DateTime @updatedAt
  lastResetAt DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LastStage {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  chapterId Int
  levelId   Int
  updatedAt DateTime @updatedAt
  score     Int      @default(0)
  stars     Int      @default(0)

  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  level   Level   @relation(fields: [levelId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Chapter {
  id         Int      @id @default(autoincrement())
  title      Json
  desc       Json
  images     Json
  orderIndex Int
  createdAt  DateTime @default(now())

  levels     Level[]
  lastStages LastStage[]
}

model Level {
  id         Int      @id @default(autoincrement())
  chapterId  Int
  number     Int
  title      Json
  desc       Json?
  difficulty Int      @default(1)
  maxStars   Int      @default(3)
  maxScore   Int      @default(100)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  chapter     Chapter           @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  completions LevelCompletion[]
  gameHistory GamePlayHistory[]
  lastStages  LastStage[]

  @@unique([chapterId, number])
  @@index([chapterId])
}

model LevelCompletion {
  id          Int      @id @default(autoincrement())
  userId      Int
  levelId     Int
  score       Int      @default(0) // คะแนนล่าสุด
  stars       Int      @default(0) // ดาวล่าสุด
  time        Int      @default(0) // ดาวล่าสุด
  completedAt DateTime @default(now())
  attempts    Int      @default(1)
  bestScore   Int      @default(0) // คะแนนสูงสุด
  bestStars   Int      @default(0) // ดาวสูงสุด
  bestTime    Int      @default(999999)

  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, levelId])
  @@index([userId, completedAt(sort: Desc)])
}

model GamePlayHistory {
  id       Int      @id @default(autoincrement())
  userId   Int
  levelId  Int
  score    Int
  stars    Int
  playTime Int
  playedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@index([userId, levelId, playedAt(sort: Desc)])
}




model Profile {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  playerName      String?
  icon            String?
  currentRank     Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserStats {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  totalScore  Int      @default(0)
  totalStars  Int      @default(0)
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([totalScore(sort: Desc)])
  @@index([totalStars(sort: Desc)])
}

model RankingCache {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  rank        Int
  points      Int
  lastUpdated DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([rank])
  @@index([points(sort: Desc)])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Role {
  USER
  ADMIN
}
