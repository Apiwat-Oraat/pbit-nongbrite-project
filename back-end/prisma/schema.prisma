generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  password     String
  name         String?
  age          Int?
  gender       Gender?
  role         Role     @default(USER)
  isVerified   Boolean  @default(false)
  refreshToken String?
  displayName  String?
  avatar       String?
  isPublic     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // relations
  achievements     AchievementUnlock[]
  lastStage        LastStage?
  levelCompletions LevelCompletion[]
  gamePlayHistory  GamePlayHistory[]
  lives            Life?
  profile          Profile?
  rankingCache     RankingCache?
  resetTokens      ResetToken[]
  streaks          Streak[]
  unlockedIcons    UserIcon[]
}

model Streak {
  id             Int       @id @default(autoincrement())
  userId         Int       @unique
  current        Int       @default(0)
  longest        Int       @default(0)
  lastActiveDate DateTime?
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id])
}

model Life {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  current     Int      @default(5)
  max         Int      @default(5)
  updatedAt   DateTime @updatedAt
  lastResetAt DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

model LastStage {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  chapterId Int
  levelId   Int
  updatedAt DateTime @updatedAt
  score     Int      @default(0)
  stars     Int      @default(0)

  chapter Chapter @relation(fields: [chapterId], references: [id])
  level   Level   @relation(fields: [levelId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
}

model Chapter {
  id         Int      @id @default(autoincrement())
  title      Json
  desc       Json
  images     Json
  orderIndex Int
  createdAt  DateTime @default(now())

  levels     Level[]
  lastStages LastStage[]
}

model Level {
  id         Int      @id @default(autoincrement())
  chapterId  Int
  number     Int
  title      Json
  desc       Json?
  difficulty Int      @default(1)
  maxStars   Int      @default(3)
  maxScore   Int      @default(100)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  chapter     Chapter           @relation(fields: [chapterId], references: [id])
  completions LevelCompletion[]
  gameHistory GamePlayHistory[]
  lastStages  LastStage[]

  @@unique([chapterId, number])
  @@index([chapterId])
}

model LevelCompletion {
  id          Int      @id @default(autoincrement())
  userId      Int
  levelId     Int
  score       Int      @default(0) // คะแนนล่าสุด
  stars       Int      @default(0) // ดาวล่าสุด
  time        Int      @default(0) // ดาวล่าสุด
  completedAt DateTime @default(now())
  attempts    Int      @default(1)
  bestScore   Int      @default(0) // คะแนนสูงสุด
  bestStars   Int      @default(0) // ดาวสูงสุด
  bestTime    Int      @default(999999)
  metadata    Json?

  level Level @relation(fields: [levelId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([userId, levelId])
  @@index([userId, completedAt(sort: Desc)])
}

model GamePlayHistory {
  id       Int      @id @default(autoincrement())
  userId   Int
  levelId  Int
  score    Int
  stars    Int
  playTime Int
  playedAt DateTime @default(now())
  metadata Json?

  user  User  @relation(fields: [userId], references: [id])
  level Level @relation(fields: [levelId], references: [id])

  @@index([userId, levelId, playedAt(sort: Desc)])
}

model Achievement {
  id         Int                 @id @default(autoincrement())
  title      Json
  desc       Json
  condition  String
  icon       String?
  orderIndex Int                 @default(0)
  isActive   Boolean             @default(true)
  createdAt  DateTime            @default(now())
  unlocks    AchievementUnlock[]
}

model AchievementUnlock {
  id            Int      @id @default(autoincrement())
  userId        Int
  achievementId Int
  unlockedAt    DateTime @default(now())
  isShowInRank  Boolean  @default(true)

  achievement Achievement @relation(fields: [achievementId], references: [id])
  user        User        @relation(fields: [userId], references: [id])

  @@unique([userId, achievementId])
  @@index([userId, unlockedAt(sort: Desc)])
}

model Profile {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  playerName      String?
  icon            String?
  totalScore      Int      @default(0) // aggregate จาก LevelCompletion.bestScore
  currentRank     Int?
  joinedDate      DateTime @default(now())
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  totalStars      Int      @default(0) // aggregate จาก LevelCompletion.bestStars
  totalMaxStars   Int      @default(0)
  isProfilePublic Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([totalScore(sort: Desc)])
  @@index([currentStreak(sort: Desc)])
}

model Icon {
  id              Int        @id @default(autoincrement())
  name            String     @unique
  imageUrl        String
  category        String?
  isDefault       Boolean    @default(false)
  unlockCondition String?
  orderIndex      Int        @default(0)
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  unlockedBy      UserIcon[]
}

model UserIcon {
  id         Int      @id @default(autoincrement())
  userId     Int
  iconId     Int
  unlockedAt DateTime @default(now())

  icon Icon @relation(fields: [iconId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([userId, iconId])
  @@index([userId])
}

model RankingCache {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  rank        Int
  points      Int
  lastUpdated DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([rank])
  @@index([points(sort: Desc)])
}

model ResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  pin       String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, pin])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Role {
  USER
  ADMIN
}
